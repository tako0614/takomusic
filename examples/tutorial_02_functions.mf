// ============================================================================
// チュートリアル 02: 関数とインポート
// ============================================================================
// このファイルでは以下を学びます:
// - 関数の定義と使用
// - 標準ライブラリ (std:core) のインポート
// - repeat, concat, overlay などのクリップ操作
// - パラメータ付き関数
//
// コンパイル: mf build examples/tutorial_02_functions.mf
// ============================================================================

// ----------------------------------------------------------------------------
// インポート: 標準ライブラリから関数を取り込む
// "std:core" には基本的なクリップ操作関数が含まれている
// ----------------------------------------------------------------------------
import { concat, repeat, overlay, padTo } from "std:core";

// ============================================================================
// パート1: 基本的な関数定義
// ============================================================================

// ----------------------------------------------------------------------------
// 関数は fn キーワードで定義
// -> Clip は戻り値の型がClipであることを示す
// ----------------------------------------------------------------------------
fn simpleMotif() -> Clip {
  return clip {
    note(C4, q, vel: 0.7);
    note(E4, q, vel: 0.72);
    note(G4, q, vel: 0.75);
    note(E4, q, vel: 0.7);
  };
}

// ----------------------------------------------------------------------------
// 別のモチーフ: 下降形
// ----------------------------------------------------------------------------
fn descendingMotif() -> Clip {
  return clip {
    note(C5, q, vel: 0.8);
    note(B4, q, vel: 0.75);
    note(A4, q, vel: 0.7);
    note(G4, q, vel: 0.7);
  };
}

// ----------------------------------------------------------------------------
// ベースライン
// ----------------------------------------------------------------------------
fn bassLine() -> Clip {
  return clip {
    note(C2, h, vel: 0.6);
    note(G2, h, vel: 0.6);
  };
}

// ----------------------------------------------------------------------------
// コード進行（伴奏パート）
// ----------------------------------------------------------------------------
fn chordProgression() -> Clip {
  return clip {
    chord([C3, E3, G3], w, vel: 0.5);    // Cメジャー
    chord([A2, C3, E3], w, vel: 0.5);    // Aマイナー
    chord([F2, A2, C3], w, vel: 0.5);    // Fメジャー
    chord([G2, B2, D3], w, vel: 0.5);    // Gメジャー
  };
}

// ============================================================================
// パート2: パラメータ付き関数
// ============================================================================

// ----------------------------------------------------------------------------
// 引数を受け取る関数
// semitones: Int で整数型のパラメータを定義
// ----------------------------------------------------------------------------
fn transposedMotif(semitones: Int) -> Clip {
  // ピッチにセミトーン数を加算して移調
  return clip {
    note(C4 + semitones, q, vel: 0.7);
    note(E4 + semitones, q, vel: 0.72);
    note(G4 + semitones, q, vel: 0.75);
    note(E4 + semitones, q, vel: 0.7);
  };
}

// ----------------------------------------------------------------------------
// 複数のパラメータを持つ関数
// ----------------------------------------------------------------------------
fn customChord(root: Int, velocity: Float) -> Clip {
  return clip {
    // root を基準にメジャーコードを構築
    // メジャーコード = ルート + 長3度(+4) + 完全5度(+7)
    chord([C4 + root, C4 + root + 4, C4 + root + 7], h, vel: velocity);
  };
}

// ============================================================================
// パート3: 標準ライブラリ関数の使用
// ============================================================================

// ----------------------------------------------------------------------------
// repeat() を使ってクリップを繰り返す
// ----------------------------------------------------------------------------
fn repeatedMotif() -> Clip {
  // simpleMotif() を4回繰り返す
  return repeat(simpleMotif(), 4);
}

// ----------------------------------------------------------------------------
// concat() を使ってクリップを連結する
// ----------------------------------------------------------------------------
fn combinedMotifs() -> Clip {
  // 上昇形の後に下降形を連結
  return concat(simpleMotif(), descendingMotif());
}

// ----------------------------------------------------------------------------
// overlay() を使ってクリップを重ねる
// 同じタイミングで複数のパートを演奏
// ----------------------------------------------------------------------------
fn layeredPart() -> Clip {
  const melody = simpleMotif();
  const bass = bassLine();
  // メロディとベースを重ねる（同時に鳴る）
  return overlay(melody, bass);
}

// ----------------------------------------------------------------------------
// 複数の関数を組み合わせた複雑な構成
// ----------------------------------------------------------------------------
fn fullSection() -> Clip {
  // 基本モチーフを2回繰り返し
  const part1 = repeat(simpleMotif(), 2);

  // 移調したモチーフを追加（5度上 = +7セミトーン）
  const part2 = transposedMotif(7);

  // 下降形で締めくくり
  const part3 = descendingMotif();

  // すべてを連結
  let result = concat(part1, part2);
  result = concat(result, part3);

  return result;
}

// ============================================================================
// パート4: 変数の使用
// ============================================================================

// ----------------------------------------------------------------------------
// const: 変更不可の変数（定数）
// let: 変更可能な変数
// ----------------------------------------------------------------------------
fn buildMelodyWithVariables() -> Clip {
  // const で定義した値は後から変更できない
  const baseVelocity = 0.7;
  const duration = q;

  // let で定義した値は後から変更できる
  let c = clip {};

  // forループで音符を追加
  const pitches = [C4, D4, E4, F4, G4, A4, B4, C5];
  for (p in pitches) {
    c = concat(c, clip { note(p, duration, vel: baseVelocity); });
  }

  return c;
}

// ============================================================================
// パート5: padTo() の使用
// ============================================================================

// ----------------------------------------------------------------------------
// padTo() でクリップの長さを指定した長さまで延長
// 足りない部分は休符になる
// ----------------------------------------------------------------------------
fn paddedMotif() -> Clip {
  const motif = simpleMotif();  // 1小節分
  // 2小節分に延長（残りは休符）
  return padTo(motif, w * 2);
}

// ============================================================================
// メイン関数: すべてをスコアにまとめる
// ============================================================================
export fn main() -> Score {
  return score {
    meta {
      title "関数とインポートのチュートリアル";
      artist "Tutorial";
    }

    meter { 1:1 -> 4/4; }
    tempo { 1:1 -> 100bpm; }

    // サウンド定義
    sound "piano" kind instrument {
      label "Piano";
      range A0..C8;
    }

    sound "bass" kind instrument {
      label "Bass";
      range E1..G3;
    }

    // ========================================================================
    // トラック1: リードメロディ
    // repeat() を使って繰り返し
    // ========================================================================
    track "Lead" role Instrument sound "piano" {
      // simpleMotif() を4回繰り返して配置
      place 1:1 repeat(simpleMotif(), 4);

      // 5小節目から移調したモチーフ
      place 5:1 repeat(transposedMotif(5), 2);  // 4度上

      // 7小節目から下降形
      place 7:1 repeat(descendingMotif(), 2);
    }

    // ========================================================================
    // トラック2: コード（伴奏）
    // 長い進行を配置
    // ========================================================================
    track "Chords" role Instrument sound "piano" {
      place 1:1 chordProgression();
      place 5:1 chordProgression();
    }

    // ========================================================================
    // トラック3: ベース
    // repeat() で繰り返し
    // ========================================================================
    track "Bass" role Instrument sound "bass" {
      place 1:1 repeat(bassLine(), 8);
    }

    // ========================================================================
    // トラック4: 組み合わせのデモ
    // concat() と repeat() の組み合わせ
    // ========================================================================
    track "Combined" role Instrument sound "piano" {
      // 最初の2小節: 基本モチーフ
      // 次の2小節: 下降形
      place 9:1 concat(
        repeat(simpleMotif(), 2),
        repeat(descendingMotif(), 2)
      );
    }
  };
}

// ============================================================================
// std:core リファレンス:
// ----------------------------------------------------------------------------
// concat(a, b)      - クリップaの後にbを連結
// repeat(c, n)      - クリップcをn回繰り返す
// overlay(a, b)     - クリップaとbを重ねる（同時再生）
// padTo(c, len)     - クリップcの長さをlenまで延長
// slice(c, s, e)    - クリップcの位置sからeまでを切り出す
// shift(c, offset)  - クリップc全体をoffset分シフト
// mapEvents(c, f)   - クリップcの各イベントに関数fを適用
// ============================================================================
